name: Update Publications

on:
  schedule:
    # Run every Sunday at 3 AM UTC (10 PM EST Saturday)
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes saved)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: scripts/requirements.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt

    - name: Run scholar metrics fetcher
      run: |
        if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
          echo "Dry run mode - would fetch scholar metrics"
          python scripts/fetch-scholar-metrics.py
          echo "Dry run complete - not committing changes"
        else
          python scripts/fetch-scholar-metrics.py
        fi

    - name: Update per-publication citations
      run: python scripts/update-publication-citations.py

    - name: Check for changes
      id: check-changes
      run: |
        if git diff --quiet public/data/scholar-metrics.json src/content/publications/ 2>/dev/null; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.check-changes.outputs.changes == 'true' && github.event.inputs.dry_run != 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add public/data/scholar-metrics.json src/content/publications/
        git diff --quiet && git diff --staged --quiet || git commit -m "Update scholar metrics and publication citations - $(date +'%Y-%m-%d')"
        # Pull with rebase to handle concurrent workflow runs, then push with retry
        for i in 1 2 3; do
          git pull --rebase origin master && git push && break
          echo "Push attempt $i failed, retrying in 5s..."
          sleep 5
        done

    - name: Create summary
      if: always()
      run: |
        echo "## Scholar Metrics Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f public/data/scholar-metrics.json ]; then
          echo "**Current Metrics:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat public/data/scholar-metrics.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "No metrics file found" >> $GITHUB_STEP_SUMMARY
        fi
