---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import PublicationsSearch from '@/components/publications/PublicationsSearch';
import ScholarMetrics from '@/components/publications/ScholarMetrics.astro';

const publications = await getCollection('publications');

// Sort by date descending
const sortedPubs = publications.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Prepare publications data for the React component
const pubsForSearch = sortedPubs.map(pub => ({
  slug: pub.slug,
  title: pub.data.title,
  authors: pub.data.authors,
  date: pub.data.date.toISOString(),
  year: pub.data.date.getFullYear(),
  publication: pub.data.publication,
  summary: pub.data.summary,
  featured: pub.data.featured,
  url_source: pub.data.url_source,
  url_pdf: pub.data.url_pdf,
  isPreprint: pub.data.publication === 'CrimRxiv',
}));

// Count publications vs preprints
const pubCount = pubsForSearch.filter(p => !p.isPreprint).length;
const preprintCount = pubsForSearch.filter(p => p.isPreprint).length;

const publicationsKeywords = [
  'policing research',
  'criminology publications',
  'police use of force studies',
  'body-worn camera research',
  'police accountability research',
  'evidence-based policing',
  'police behavior research',
  'law enforcement policy research',
  'criminal justice scholarship',
  'peer-reviewed policing articles',
];
---

<BaseLayout
  title="Publications"
  description={`${pubCount}+ peer-reviewed publications on policing, use of force, body cameras, and police accountability by Dr. Ian T. Adams. Research cited in Criminology, Justice Quarterly, and Public Administration Review.`}
  keywords={publicationsKeywords}
>
  <section class="section">
    <div class="container-wide">
      <!-- Header -->
      <header class="border-b-4 border-primary-700 dark:border-primary-500 pb-8 mb-12">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-1 h-12 bg-primary-700 dark:bg-primary-500"></div>
          <span class="text-sm font-bold tracking-widest uppercase text-primary-700 dark:text-primary-400">
            Peer-Reviewed Research
          </span>
        </div>
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-serif font-bold text-gray-900 dark:text-white leading-tight mb-4">
          Publications
        </h1>
        <p class="text-xl md:text-2xl text-gray-600 dark:text-gray-300 max-w-3xl font-light leading-relaxed">
          Peer-reviewed publications on policing policy, technology, behavior, and use-of-force in law enforcement.
        </p>
      </header>

      <!-- Google Scholar Stats - fetched client-side for reliability -->
      <ScholarMetrics pubCount={pubCount} />

      <!-- Publications Search and List -->
      <PublicationsSearch client:load publications={pubsForSearch} />
    </div>
  </section>
</BaseLayout>
