---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import scholarMetrics from '@/../public/data/scholar-metrics.json';
import PublicationsSearch from '@/components/publications/PublicationsSearch';

const publications = await getCollection('publications');

// Sort by date descending
const sortedPubs = publications.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Prepare publications data for the React component
const pubsForSearch = sortedPubs.map(pub => ({
  slug: pub.slug,
  title: pub.data.title,
  authors: pub.data.authors,
  date: pub.data.date.toISOString(),
  year: pub.data.date.getFullYear(),
  publication: pub.data.publication,
  summary: pub.data.summary,
  featured: pub.data.featured,
  url_source: pub.data.url_source,
  url_pdf: pub.data.url_pdf,
}));
---

<BaseLayout
  title="Publications"
  description="Academic publications by Ian T. Adams, Ph.D."
>
  <section class="section">
    <div class="container-wide">
      <!-- Header -->
      <header class="mb-12">
        <h1 class="text-4xl md:text-5xl font-serif font-bold text-primary-900 dark:text-gray-100 mb-4">
          Publications
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-400 max-w-3xl">
          Over fifty peer-reviewed publications on policing policy, technology, behavior, and use-of-force in law enforcement.
        </p>
      </header>

      <!-- Google Scholar Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
        <div class="card p-4 text-center">
          <div class="text-3xl font-bold text-primary-900 dark:text-gray-100">
            {scholarMetrics.citations?.toLocaleString() ?? '—'}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Total Citations</div>
        </div>
        <div class="card p-4 text-center group relative cursor-help !overflow-visible">
          <div class="text-3xl font-bold text-primary-900 dark:text-gray-100">
            {scholarMetrics.h_index ?? '—'}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">
            h-index
            <span class="inline-block ml-1 text-gray-400 dark:text-gray-500">&#9432;</span>
          </div>
          <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 dark:bg-gray-700 text-white text-xs rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none w-64 text-left z-50 shadow-lg">
            The h-index measures productivity and citation impact. An h-index of {scholarMetrics.h_index} means {scholarMetrics.h_index} publications have been cited at least {scholarMetrics.h_index} times each.
            <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900 dark:border-t-gray-700"></div>
          </div>
        </div>
        <div class="card p-4 text-center group relative cursor-help !overflow-visible">
          <div class="text-3xl font-bold text-primary-900 dark:text-gray-100">
            {scholarMetrics.i10_index ?? '—'}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">
            i10-index
            <span class="inline-block ml-1 text-gray-400 dark:text-gray-500">&#9432;</span>
          </div>
          <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 dark:bg-gray-700 text-white text-xs rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none w-64 text-left z-50 shadow-lg">
            The i10-index counts publications with at least 10 citations. An i10-index of {scholarMetrics.i10_index} means {scholarMetrics.i10_index} publications have 10 or more citations.
            <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900 dark:border-t-gray-700"></div>
          </div>
        </div>
        <div class="card p-4 text-center">
          <div class="text-3xl font-bold text-primary-900 dark:text-gray-100">
            {publications.length}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Publications</div>
        </div>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-500 mb-8 -mt-8">
        Metrics from <a href={scholarMetrics.scholar_url} target="_blank" rel="noopener noreferrer" class="underline hover:text-primary-700 dark:hover:text-primary-400">Google Scholar</a>
      </p>

      <!-- Publications Search and List -->
      <PublicationsSearch client:load publications={pubsForSearch} />
    </div>
  </section>
</BaseLayout>
