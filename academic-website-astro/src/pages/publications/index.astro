---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import scholarMetrics from '@/../public/data/scholar-metrics.json';
import PublicationsSearch from '@/components/publications/PublicationsSearch';

const publications = await getCollection('publications');

// Sort by date descending
const sortedPubs = publications.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Prepare publications data for the React component
const pubsForSearch = sortedPubs.map(pub => ({
  slug: pub.slug,
  title: pub.data.title,
  authors: pub.data.authors,
  date: pub.data.date.toISOString(),
  year: pub.data.date.getFullYear(),
  publication: pub.data.publication,
  summary: pub.data.summary,
  featured: pub.data.featured,
  url_source: pub.data.url_source,
  url_pdf: pub.data.url_pdf,
}));
---

<BaseLayout
  title="Publications"
  description="Academic publications by Ian T. Adams, Ph.D."
>
  <section class="section">
    <div class="container-wide">
      <!-- Header -->
      <header class="mb-12">
        <h1 class="text-4xl md:text-5xl font-serif font-bold text-primary-900 dark:text-gray-100 mb-4">
          Publications
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-400 max-w-3xl">
          Over fifty peer-reviewed publications on policing policy, technology, behavior, and use-of-force in law enforcement.
        </p>
      </header>

      <!-- Google Scholar Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
        <div class="card p-4 text-center">
          <div class="text-3xl font-bold text-primary-900 dark:text-gray-100">
            {scholarMetrics.citations?.toLocaleString() ?? '—'}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Total Citations</div>
        </div>
        <div class="card p-4 text-center">
          <div class="text-3xl font-bold text-primary-900 dark:text-gray-100">
            {scholarMetrics.h_index ?? '—'}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">h-index</div>
        </div>
        <div class="card p-4 text-center">
          <div class="text-3xl font-bold text-primary-900 dark:text-gray-100">
            {scholarMetrics.i10_index ?? '—'}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">i10-index</div>
        </div>
        <div class="card p-4 text-center">
          <div class="text-3xl font-bold text-primary-900 dark:text-gray-100">
            {publications.length}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Publications</div>
        </div>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-500 mb-8 -mt-8">
        Metrics from <a href={scholarMetrics.scholar_url} target="_blank" rel="noopener noreferrer" class="underline hover:text-primary-700 dark:hover:text-primary-400">Google Scholar</a>
      </p>

      <!-- Publications Search and List -->
      <PublicationsSearch client:load publications={pubsForSearch} />
    </div>
  </section>
</BaseLayout>
