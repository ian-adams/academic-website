---
import '@/styles/global.css';
import Header from '@/components/common/Header.astro';
import Footer from '@/components/common/Footer.astro';
import { siteConfig } from '@/data/site';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  article?: boolean;
  keywords?: string[];
  datePublished?: string;
  dateModified?: string;
}

const {
  title = siteConfig.title,
  description = siteConfig.description,
  image = '/media/og-image.jpg',
  article = false,
  keywords = [],
  datePublished,
  dateModified,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, siteConfig.url);
const fullTitle = title === siteConfig.title ? title : `${title} | ${siteConfig.name}`;

// Default keywords for SEO targeting scholars, police executives, and litigation attorneys
const defaultKeywords = [
  'police research',
  'criminology',
  'law enforcement policy',
  'use of force',
  'police accountability',
  'Section 1983',
  'qualified immunity',
  'police litigation',
  'body-worn cameras',
  'police training',
  'evidence-based policing',
];
const allKeywords = [...new Set([...keywords, ...defaultKeywords])];

// JSON-LD structured data for Person (Dr. Ian Adams)
const personSchema = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: siteConfig.author.name,
  givenName: 'Ian',
  familyName: 'Adams',
  honorificSuffix: 'Ph.D.',
  jobTitle: 'Assistant Professor',
  worksFor: {
    '@type': 'Organization',
    name: siteConfig.author.institution,
    department: {
      '@type': 'Organization',
      name: 'Department of Criminology & Criminal Justice',
    },
  },
  url: siteConfig.url,
  email: siteConfig.author.email,
  image: new URL(siteConfig.author.avatar, siteConfig.url).href,
  sameAs: [
    siteConfig.author.social.twitter,
    siteConfig.author.social.googleScholar,
    siteConfig.author.social.github,
    siteConfig.author.social.researchGate,
  ],
  knowsAbout: [
    'Police Use of Force',
    'Body-Worn Cameras',
    'Artificial Intelligence in Policing',
    'Police Accountability',
    'Criminal Justice Policy',
    'Evidence-Based Policing',
    'Police Training',
    'Section 1983 Litigation',
  ],
  alumniOf: siteConfig.author.education.map((edu) => ({
    '@type': 'EducationalOrganization',
    name: edu.institution,
  })),
};

// JSON-LD for the WebSite
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: siteConfig.title,
  url: siteConfig.url,
  description: siteConfig.description,
  author: { '@id': `${siteConfig.url}/#person` },
  publisher: { '@id': `${siteConfig.url}/#person` },
  inLanguage: 'en-US',
  copyrightHolder: { '@id': `${siteConfig.url}/#person` },
  keywords: allKeywords.join(', '),
};

// JSON-LD for articles/pages
const articleSchema = article ? {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description: description,
  url: canonicalURL.href,
  author: { '@id': `${siteConfig.url}/#person` },
  publisher: { '@id': `${siteConfig.url}/#person` },
  image: new URL(image, siteConfig.url).href,
  datePublished: datePublished,
  dateModified: dateModified || datePublished,
  mainEntityOfPage: canonicalURL.href,
  keywords: allKeywords.join(', '),
} : null;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={article ? 'article' : 'website'} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, siteConfig.url)} />
    <meta property="og:site_name" content={siteConfig.name} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, siteConfig.url)} />

    <!-- Additional SEO Meta Tags -->
    <meta name="keywords" content={allKeywords.join(', ')} />
    <meta name="author" content={siteConfig.author.name} />
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />

    <!-- Academic/Scholar specific meta -->
    <meta name="citation_author" content="Adams, Ian T." />
    <meta name="citation_author_institution" content={siteConfig.author.institution} />
    <meta name="DC.creator" content={siteConfig.author.name} />
    <meta name="DC.publisher" content={siteConfig.author.institution} />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(personSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
    {articleSchema && <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />}

    <!-- Theme initialization (prevent flash) -->
    <script is:inline>
      const theme = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      })();
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
  </head>
  <body class="min-h-screen flex flex-col">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-[100] focus:px-4 focus:py-2 focus:bg-primary-700 focus:text-white focus:rounded-lg focus:text-sm focus:font-medium">
      Skip to main content
    </a>
    <Header />
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    <Footer />
  </body>
</html>
